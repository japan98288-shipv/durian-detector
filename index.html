<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>intelligent Leaf Scan AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* เพื่อให้ Canvas และ Video ซ้อนทับกันได้พอดี */
        .video-container {
            position: relative;
            display: inline-block;
            overflow: hidden; /* ซ่อนส่วนเกิน */
        }
        #canvasOverlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
        /* ถ้าต้องการให้ภาพจากกล้องหน้าไม่กลับด้าน (Mirror) */
        #videoElement {
             transform: scaleX(-1);
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top shadow-lg">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">intelligent LeafScanner</a>
            <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu">
                <i class="bi bi-list fs-4"></i>
            </button>
        </div>
    </nav>
    
    <div style="height: 60px;"></div> 

    <div class="container mt-4">

        <div id="camera_section">
            <h1 class="text-center mb-4 text-success fw-bold">หน้าตรวจจับโรคทุเรียน</h1>
            
            <div class="card shadow-lg mx-auto" style="max-width: 640px;">
                <div class="card-body p-0"> 
                    <div class="video-container">
                        <video id="videoElement" class="card-img-top" autoplay playsinline></video>
                        <canvas id="canvasOverlay"></canvas>
                    </div>
                </div>
                
                <div class="card-footer text-center p-3 bg-white">
                    <button id="startButton" class="btn btn-primary btn-lg w-100 shadow-sm">
                        <i class="bi bi-camera-video"></i> เริ่มตรวจจับ
                    </button>
                    <p id="status" class="mt-3 fs-6 fw-bold text-info">รอการเริ่ม...</p>
                    <p id="detectionCount" class="text-muted small">ตรวจพบ: 0</p>
                </div>
            </div>
        </div>
        
        <div id="results_history" class="container mt-5 p-4 border rounded bg-white shadow-sm">
            <h2 class="text-primary"><i class="bi bi-list-columns"></i> ประวัติผลลัพธ์</h2>
            <p class="text-muted">ส่วนนี้จะแสดงผลการตรวจจับที่ผ่านมา (ต้องพัฒนาเพิ่มเติม)</p>
        </div>

    </div> <div class="offcanvas offcanvas-start bg-light" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
        <div class="offcanvas-header bg-success text-white">
            <h5 class="offcanvas-title" id="offcanvasMenuLabel">ตัวเลือกเมนู</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                <li class="nav-item mb-2">
                    <a class="nav-link active fs-5 text-success" href="#camera_section" data-bs-dismiss="offcanvas">
                        <i class="bi bi-camera-video"></i> หน้าตรวจจับ (กล้อง)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ใบทุเรียน
                    </a>
                </li>
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ใบมังคุด
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ใบเงาะ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ใบลองกอง
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
    
        const API_URL = "https://unintroductory-stanford-preconversational.ngrok-free.dev/detect_disease"; // เปลี่ยนตรงนี้
        
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasOverlay');
        const startButton = document.getElementById('startButton');
        const statusElement = document.getElementById('status');
        const detectionCountElement = document.getElementById('detectionCount');
        const ctx = canvas.getContext('2d');
        
        let stream = null;
        let isProcessing = false;

        // ฟังก์ชันเริ่มต้นกล้อง
        async function startCamera() {
            try {
                statusElement.textContent = "กำลังเชื่อมต่อกล้อง...";
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // ใช้กล้องหลังมือถือ
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    // กำหนดขนาด Canvas ให้เท่ากับ Video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    video.style.height = `${video.videoHeight}px`; 
                    video.style.width = `${video.videoWidth}px`;
                    canvas.style.height = `${video.videoHeight}px`; 
                    canvas.style.width = `${video.videoWidth}px`;
                    
                    statusElement.textContent = "กล้องพร้อมใช้งาน กด 'เริ่มตรวจจับ'";
                    startButton.textContent = "หยุดตรวจจับ";
                    startButton.classList.remove('btn-primary');
                    startButton.classList.add('btn-danger');

                    // เริ่มวนลูปส่งภาพเมื่อผู้ใช้กดปุ่ม
                    startButton.onclick = stopDetection;
                };

            } catch (err) {
                console.error("Error accessing camera: ", err);
                statusElement.textContent = `ข้อผิดพลาด: ไม่สามารถเข้าถึงกล้อง (${err.message})`;
                startButton.textContent = "เริ่มตรวจจับ (ผิดพลาด)";
            }
        }

        // ฟังก์ชันหยุดการตรวจจับ
        function stopDetection() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            isProcessing = false;
            statusElement.textContent = "หยุดการตรวจจับแล้ว";
            startButton.textContent = "เริ่มตรวจจับ";
            startButton.classList.remove('btn-danger');
            startButton.classList.add('btn-primary');
            startButton.onclick = startCamera;
            
            // ล้าง Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // ฟังก์ชันส่งภาพไปยัง Backend
        async function sendFrame() {
            if (!isProcessing || video.paused || video.ended) {
                isProcessing = false;
                return;
            }

            try {
                // 1. วาดเฟรมปัจจุบันลงบน Canvas เพื่อดึงข้อมูล
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // 2. แปลง Canvas เป็น Blob (ภาพ JPEG)
                canvas.toBlob(async (blob) => {
                    if (!blob) return;

                    const formData = new FormData();
                    formData.append('file', blob, 'frame.jpg');

                    statusElement.textContent = "กำลังส่งภาพและประมวลผล...";
                    
                    // 3. ส่ง POST Request ไปยัง FastAPI
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: formData,
                        // ไม่ต้องกำหนด Content-Type เพราะ FormData จะจัดการเอง
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // 4. แสดงภาพที่ถูกตรวจจับแล้ว
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // แสดงผลลัพธ์
                        detectionCountElement.textContent = `ตรวจพบ: ${result.detections} วัตถุ`;
                        statusElement.textContent = "ตรวจจับสำเร็จ! กำลังเตรียมเฟรมถัดไป...";
                        
                        // เรียกส่งภาพถัดไปทันที
                        setTimeout(sendFrame, 100); // ดีเลย์ 100ms เพื่อลดภาระ CPU
                    };
                    img.src = 'data:image/jpeg;base64,' + result.image_base64;

                }, 'image/jpeg', 0.8); // กำหนดคุณภาพ JPEG

            } catch (error) {
                statusElement.textContent = `ข้อผิดพลาด Server: ${error.message}. กรุณาตรวจสอบ ngrok/FastAPI`;
                console.error("Detection API Error:", error);
                // หยุดการประมวลผล
                isProcessing = false; 
                stopDetection();
            }
        }
        
        // เมื่อกดปุ่ม 'เริ่มตรวจจับ'
        startButton.onclick = () => {
             if (stream && isProcessing) {
                 stopDetection();
             } else {
                 isProcessing = true;
                 startCamera().then(() => {
                     // เริ่มส่งเฟรมหลังจากกล้องเริ่มทำงาน
                     if(isProcessing) sendFrame();
                 });
             }
        };

        // เมื่อหน้าต่างโหลดเสร็จ
        window.onload = function() {
            statusElement.textContent = "กรุณาเปิดกล้องและเริ่มตรวจจับ";
        };

    </script>
</body>
</html>