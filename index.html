<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± Durian Leaf Scan AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Canvas ‡πÅ‡∏•‡∏∞ Video ‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏û‡∏≠‡∏î‡∏µ */
        .video-container {
            position: relative;
            display: inline-block;
            overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô */
        }
        #canvasOverlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
        /* ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô (Mirror) */
        #videoElement {
             transform: scaleX(-1);
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top shadow-lg">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">üå± LeafScan AI</a>
            <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu">
                <i class="bi bi-list fs-4"></i>
            </button>
        </div>
    </nav>
    
    <div style="height: 60px;"></div> 

    <div class="container mt-4">

        <div id="camera_section">
            <h1 class="text-center mb-4 text-success fw-bold">‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            
            <div class="card shadow-lg mx-auto" style="max-width: 600px;">
                <div class="card-body p-0"> 
                    <div class="video-container">
                        <video id="videoElement" class="card-img-top" autoplay playsinline></video>
                        <canvas id="canvasOverlay"></canvas>
                    </div>
                </div>
                
                <div class="card-footer text-center p-3 bg-white">
                    <button id="startButton" class="btn btn-primary btn-lg w-100 shadow-sm">
                        <i class="bi bi-camera-video"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                    </button>
                    <p id="status" class="mt-3 fs-6 fw-bold text-info">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                    <p id="detectionCount" class="text-muted small">‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: 0</p>
                </div>
            </div>
        </div>
        
        <div id="results_history" class="container mt-5 p-4 border rounded bg-white shadow-sm">
            <h2 class="text-primary"><i class="bi bi-list-columns"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>
            <p class="text-muted">‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)</p>
        </div>

    </div> <div class="offcanvas offcanvas-start bg-light" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
        <div class="offcanvas-header bg-success text-white">
            <h5 class="offcanvas-title" id="offcanvasMenuLabel">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                <li class="nav-item mb-2">
                    <a class="nav-link active fs-5 text-success" href="#camera_section" data-bs-dismiss="offcanvas">
                        <i class="bi bi-camera-video"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö (‡∏Å‡∏•‡πâ‡∏≠‡∏á)
                    </a>
                </li>
                <li class="nav-item mb-2">
                    <a class="nav-link fs-5" href="#results_history" data-bs-dismiss="offcanvas">
                        <i class="bi bi-list-columns"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        // *******************************************************************
        // !!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å ngrok ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô ngrok ‡πÉ‡∏´‡∏°‡πà
        // *******************************************************************
        const API_URL = "https://xxxx-yyyy-zzzz.ngrok-free.app/detect_disease"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasOverlay');
        const startButton = document.getElementById('startButton');
        const statusElement = document.getElementById('status');
        const detectionCountElement = document.getElementById('detectionCount');
        const ctx = canvas.getContext('2d');
        
        let stream = null;
        let isProcessing = false;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
        async function startCamera() {
            try {
                statusElement.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö Video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    video.style.height = `${video.videoHeight}px`; 
                    video.style.width = `${video.videoWidth}px`;
                    canvas.style.height = `${video.videoHeight}px`; 
                    canvas.style.width = `${video.videoWidth}px`;
                    
                    statusElement.textContent = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö'";
                    startButton.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö";
                    startButton.classList.remove('btn-primary');
                    startButton.classList.add('btn-danger');

                    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
                    startButton.onclick = stopDetection;
                };

            } catch (err) {
                console.error("Error accessing camera: ", err);
                statusElement.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (${err.message})`;
                startButton.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö (‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)";
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
        function stopDetection() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            isProcessing = false;
            statusElement.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
            startButton.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö";
            startButton.classList.remove('btn-danger');
            startButton.classList.add('btn-primary');
            startButton.onclick = startCamera;
            
            // ‡∏•‡πâ‡∏≤‡∏á Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend
        async function sendFrame() {
            if (!isProcessing || video.paused || video.ended) {
                isProcessing = false;
                return;
            }

            try {
                // 1. ‡∏ß‡∏≤‡∏î‡πÄ‡∏ü‡∏£‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏•‡∏á‡∏ö‡∏ô Canvas ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // 2. ‡πÅ‡∏õ‡∏•‡∏á Canvas ‡πÄ‡∏õ‡πá‡∏ô Blob (‡∏†‡∏≤‡∏û JPEG)
                canvas.toBlob(async (blob) => {
                    if (!blob) return;

                    const formData = new FormData();
                    formData.append('file', blob, 'frame.jpg');

                    statusElement.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
                    
                    // 3. ‡∏™‡πà‡∏á POST Request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á FastAPI
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: formData,
                        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î Content-Type ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ FormData ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        detectionCountElement.textContent = `‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: ${result.detections} ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏`;
                        statusElement.textContent = "‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏ü‡∏£‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ...";
                        
                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        setTimeout(sendFrame, 100); // ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå 100ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞ CPU
                    };
                    img.src = 'data:image/jpeg;base64,' + result.image_base64;

                }, 'image/jpeg', 0.8); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û JPEG

            } catch (error) {
                statusElement.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Server: ${error.message}. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ngrok/FastAPI`;
                console.error("Detection API Error:", error);
                // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                isProcessing = false; 
                stopDetection();
            }
        }
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö'
        startButton.onclick = () => {
             if (stream && isProcessing) {
                 stopDetection();
             } else {
                 isProcessing = true;
                 startCamera().then(() => {
                     // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏ü‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                     if(isProcessing) sendFrame();
                 });
             }
        };

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        window.onload = function() {
            statusElement.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö";
        };

    </script>
</body>
</html>