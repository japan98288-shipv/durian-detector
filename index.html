<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Leaf Scan AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Canvas ‡πÅ‡∏•‡∏∞ Video ‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏û‡∏≠‡∏î‡∏µ */
        .video-container {
            position: relative;
            display: inline-block;
            overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô */
        }
        #canvasOverlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
        /* ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô (Mirror) */
        #videoElement {
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top shadow-lg">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">intelligent LeafScanner</a>
            <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu">
                <i class="bi bi-list fs-4"></i>
            </button>
        </div>
    </nav>
    
    <div style="height: 60px;"></div> 

    <div class="container mt-4">

        <div id="camera_section">
            <h1 class="text-center mb-4 text-success fw-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡πÇ‡∏£‡∏Ñ</h1>
            
            <div class="card shadow-lg mx-auto" style="max-width: 640px;">
                <div class="card-body p-0"> 
                    <div class="video-container">
                        <video id="videoElement" class="card-img-top" autoplay playsinline></video>
                        <canvas id="canvasOverlay"></canvas>
                    </div>
                </div>
                
                <div class="card-footer text-center p-3 bg-white">
                    <button id="startButton" class="btn btn-primary btn-lg w-100 shadow-sm">
                        <i class="bi bi-camera-video"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                    </button>
                    <p id="status" class="mt-3 fs-6 fw-bold text-info">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                    <p id="connectionStatus" class="mt-2 fs-6 fw-bold text-danger">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</p> 
                    <p id="detectionCount" class="text-muted small">‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: 0</p>
                </div>
            </div>
        </div>
        
        <div id="results_history" class="container mt-5 p-4 border rounded bg-white shadow-sm">
            <h2 class="text-primary"><i class="bi bi-list-columns"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>
            <p class="text-muted">‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)</p>
        </div>

    </div> 
    
    <div class="offcanvas offcanvas-start bg-light" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
        <div class="offcanvas-header bg-success text-white">
            <h5 class="offcanvas-title" id="offcanvasMenuLabel">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                <li class="nav-item mb-2">
                    <a class="nav-link active fs-5 text-success" href="#camera_section" data-bs-dismiss="offcanvas">
                        <i class="bi bi-camera-video"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö (‡∏Å‡∏•‡πâ‡∏≠‡∏á)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ‡πÉ‡∏ö‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </a>
                </li>
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ‡πÉ‡∏ö‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ‡πÉ‡∏ö‡πÄ‡∏á‡∏≤‡∏∞
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fs-5" href="https://github.com/your-username/your-repo" target="_blank" data-bs-dismiss="offcanvas">
                        <i class="bi bi-github"></i> ‡πÉ‡∏ö‡∏•‡∏≠‡∏á‡∏Å‡∏≠‡∏á
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
    
    const BASE_API_URL = "https://tawanna-ionogenic-gyrally.ngrok-free.dev"; 
    const API_URL = `${BASE_API_URL}/detect_disease`; 
    
    // ** ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î Input ‡∏Ç‡∏≠‡∏á AI ‡πÉ‡∏ô Frontend ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend **
    const AI_INPUT_SIZE = 416; 

    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvasOverlay');
    const startButton = document.getElementById('startButton');
    const statusElement = document.getElementById('status');
    const detectionCountElement = document.getElementById('detectionCount');
    const connectionStatusElement = document.getElementById('connectionStatus');
    const ctx = canvas.getContext('2d');
    
    let stream = null;
    let isProcessing = false;
    let isBackendConnected = false;
    
    let latestDetectionData = { boxes: [], detections: 0 }; 

    let frameSendInterval = 550; 
    let lastSendTime = 0; 

    // ----------------------------------------------------------------------
    // ** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: Loop ‡∏Å‡∏≤‡∏£ Render 60 FPS (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö) **
    // ----------------------------------------------------------------------
    function drawLoop() {
        if (!isProcessing) return; 

        // 1. ‡∏ß‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡∏î (Video Feed) ‡∏•‡∏á Canvas ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (60 FPS)
        // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏î‡∏π‡∏™‡∏°‡∏π‡∏ó
        // üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏î video ‡∏•‡∏á canvas ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏£‡∏≤‡∏∞ canvas overlay ‡∏ó‡∏±‡∏ö video element
        // ctx.clearRect(0, 0, canvas.width, canvas.height); 
        // ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // 1.1 ‡∏•‡πâ‡∏≤‡∏á Canvas Overlay ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 2. ‡∏ß‡∏≤‡∏î Bounding Box ‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        drawBoundingBoxes(latestDetectionData.boxes); // <--- ‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 60 FPS

        // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend (‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° frameSendInterval)
        const now = performance.now();
        if (now - lastSendTime >= frameSendInterval) {
            sendFrame(now); 
            lastSendTime = now;
        }

        requestAnimationFrame(drawLoop);
    }

    // ----------------------------------------------------------------------
    // ** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏ß‡∏≤‡∏î Bounding Box ‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î JSON (‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Scaling) **
    // ----------------------------------------------------------------------
    function drawBoundingBoxes(boxes) {
        if (!boxes || boxes.length === 0) return;

        // üí° ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CRITICAL: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô Scale ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡∏ô‡∏≤‡∏î Video/Canvas ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö AI_INPUT_SIZE (416)
        const scaleX = canvas.width / AI_INPUT_SIZE;
        const scaleY = canvas.height / AI_INPUT_SIZE;
        
        // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î
        ctx.lineWidth = 3;
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'start';

        boxes.forEach(detection => {
            // [x1, y1, x2, y2] ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Backend (‡∏™‡πÄ‡∏Å‡∏• 416)
            const [x1_ai, y1_ai, x2_ai, y2_ai] = detection.box; 
            const label = `${detection.class} (${(detection.confidence * 100).toFixed(1)}%)`;
            
            // 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î: ‡∏ô‡∏≥‡∏û‡∏¥‡∏Å‡∏±‡∏î 416 ‡∏°‡∏≤‡∏Ñ‡∏π‡∏ì‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô Scale
            const x1 = x1_ai * scaleX;
            const y1 = y1_ai * scaleY;
            const width = (x2_ai - x1_ai) * scaleX;
            const height = (y2_ai - y1_ai) * scaleY;
            
            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á (Stroke Rect)
            ctx.strokeStyle = '#dc3545'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° (Bootstrap danger)
            ctx.strokeRect(x1, y1, width, height); 
            
            // ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            ctx.fillStyle = '#dc3545'; 
            ctx.fillRect(
                x1, 
                y1 - 20, 
                ctx.measureText(label).width + 10, // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                20
            );
            
            // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            ctx.fillStyle = 'white';
            ctx.fillText(label, x1 + 5, y1 - 5);
        });
    }
    
    // ----------------------------------------------------------------------
    // ** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) **
    // ----------------------------------------------------------------------
    
    async function checkBackendConnectivity() {
        try {
            connectionStatusElement.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
            connectionStatusElement.classList.remove('text-success', 'text-danger');
            connectionStatusElement.classList.add('text-warning');

            const response = await fetch(BASE_API_URL, { method: 'GET' });

            if (response.ok || response.status === 404 || response.status === 405) {
                isBackendConnected = true;
                connectionStatusElement.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)";
                connectionStatusElement.classList.remove('text-warning', 'text-danger');
                connectionStatusElement.classList.add('text-success');
                return true;
            } else {
                throw new Error(`Server responded with status: ${response.status}`);
            }

        } catch (error) {
            isBackendConnected = false;
            connectionStatusElement.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API: ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! (${error.message})`;
            connectionStatusElement.classList.remove('text-warning', 'text-success');
            connectionStatusElement.classList.add('text-danger');
            statusElement.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Backend ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Cloudflare Tunnel/FastAPI";
            console.error("Backend Connection Check Failed:", error);
            return false;
        }
    }
    
    async function startCamera() {
        if (!isBackendConnected) {
            statusElement.textContent = "‡∏´‡∏¢‡∏∏‡∏î! Backend ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API";
            return;
        }

        try {
            statusElement.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                video.play();
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö Video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á Video ‡πÅ‡∏•‡∏∞ Canvas ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                video.style.height = `${video.videoHeight}px`; 
                video.style.width = `${video.videoWidth}px`;
                canvas.style.height = `${video.videoHeight}px`; 
                canvas.style.width = `${video.videoWidth}px`;
                
                statusElement.textContent = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö...";
                startButton.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö";
                startButton.classList.remove('btn-primary');
                startButton.classList.add('btn-danger');

                isProcessing = true;
                drawLoop(); // ** ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏π‡∏õ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û 60 FPS **
                
                startButton.onclick = stopDetection;
            };

        } catch (err) {
            console.error("Error accessing camera: ", err);
            statusElement.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (${err.message})`;
            startButton.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö (‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)";
        }
    }

    function stopDetection() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        isProcessing = false;
        statusElement.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
        startButton.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö";
        startButton.classList.remove('btn-danger');
        startButton.classList.add('btn-primary');
        startButton.onclick = startDetectionProcess; 
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        latestDetectionData = { boxes: [], detections: 0 }; 
    }

    async function sendFrame(sendTime) {
        if (!isProcessing || video.paused || video.ended) {
            return;
        }

        try {
            // 1. ‡∏ß‡∏≤‡∏î‡πÄ‡∏ü‡∏£‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏•‡∏á‡∏ö‡∏ô Canvas ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á
            // üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ canvas ‡πÄ‡∏û‡∏∑‡πà‡∏≠ capture frame ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏î‡∏ã‡πâ‡∏≥‡πÉ‡∏ô drawLoop
            const captureCanvas = document.createElement('canvas');
            const captureCtx = captureCanvas.getContext('2d');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
            
            // 2. ‡πÅ‡∏õ‡∏•‡∏á Canvas ‡πÄ‡∏õ‡πá‡∏ô Blob (‡∏†‡∏≤‡∏û JPEG)
            captureCanvas.toBlob(async (blob) => {
                if (!blob) return;

                const formData = new FormData();
                formData.append('file', blob, 'frame.jpg');

                statusElement.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
                
                // 3. ‡∏™‡πà‡∏á POST Request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á FastAPI
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // 4. ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå JSON ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á)
                latestDetectionData = {
                    boxes: result.boxes,
                    detections: result.detections
                };
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                detectionCountElement.textContent = `‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: ${result.detections} ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏`;
                const processingTime = performance.now() - sendTime;
                statusElement.textContent = `‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Lat: ${processingTime.toFixed(0)}ms) - ${Math.round(1000/frameSendInterval)} FPS`;

            }, 'image/jpeg', 0.7); 

        } catch (error) {
            statusElement.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Server: ${error.message}. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏∏‡∏î`;
            console.error("Detection API Error:", error);
            connectionStatusElement.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API: ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£`;
            connectionStatusElement.classList.remove('text-success', 'text-warning');
            connectionStatusElement.classList.add('text-danger');
            
            isProcessing = false; 
            stopDetection();
        }
    }
    
    async function startDetectionProcess() {
        const isReady = await checkBackendConnectivity(); 
        if (isReady) {
            isProcessing = true;
            startCamera(); 
        } else {
            isProcessing = false;
        }
    };

    startButton.onclick = startDetectionProcess;

    window.onload = async function() {
        statusElement.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö";
        await checkBackendConnectivity(); 
    };
</script>
</body>
</html>